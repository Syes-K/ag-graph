!function(t,e,n){var i="function"==typeof n.define,o=n.module&&"function"!=typeof n.module&&n.module.exports;i?define(e):o?module.exports=e():n.AgGraph=e()}(0,function(){function t(t,e){var n;return function(){var i=this,o=arguments;clearTimeout(n),n=setTimeout(function(){t.apply(i,o)},e)}}function e(t,e,n,i){t[v+e]=n,Object.defineProperty(t,e,{get:function(){return t[v+e]},set:function(n){t[v+e];t[v+e]=n,i.apply(t)}})}function n(t,e){var n,i=t.indexOf(e);return i>=0&&(n=t.splice(i,1)),n}function i(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function o(t,e){var n=t.x,i=t.y,o=e.x,r=e.y,s=Math.abs(n-o),a=Math.abs(i-r),h=a/Math.sqrt(Math.pow(s,2)+Math.pow(a,2)),d=Math.asin(h),c=180/(Math.PI/d);return o>n&&r>i&&(c=c),o==n&&r>i&&(c=90),o>n&&r==i&&(c=0),o<n&&r>i&&(c=180-c),o<n&&r==i&&(c=180),o<n&&r<i&&(c=180+c),o==n&&r<i&&(c=270),o>n&&r<i&&(c=360-c),o==n&&r==i&&(c=0),c}function r(t,e){for(var n,r,s,a=0,h=0;!s;){n=t[a];var d=t[a+1];if(!d)break;e<=h+(r=i(n,d))?s=d:(h+=r,a++)}if(s){var c=o(n,s);return{x:n.x+(s.x-n.x)*(e-h)/r,y:n.y+(s.y-n.y)*(e-h)/r,angel:c}}}function s(t){var n=this;n.agGraph=t;var i=t.$svg.node().getBoundingClientRect();n.lastScale=1,e(n,"viewBox",[-i.width/2,-i.height/2,i.width,i.height],n._setViewBox),e(n,"scale",1,n._setScale);var o=d3.drag().on("start",function(){var t=d3.event.x,e=d3.event.y;y.offset={x:n.viewBox[0]+t/n.scale,y:n.viewBox[1]+e/n.scale}}).on("drag",function(){var t=d3.event.x,e=d3.event.y,i=y.offset.x-t/n.scale,o=y.offset.y-e/n.scale;n.viewBox=[i,o,n.viewBox[2],n.viewBox[3]]}).on("end",function(){t._emit("view.move",n)});o.clickDistance(5),n.agGraph.$svg.call(o).on("click",function(){t.selection.clearNodes(),t.selection.clearLines(),t.selection.clearPoints(),t._emit("view.click",n)}).on("contextmenu",function(){d3.event.stopPropagation(),d3.event.preventDefault();var e={x:d3.event.x,y:d3.event.y},i=n.agGraph._container.offsetParent.getBoundingClientRect(),o={x:e.x-i.x,y:e.y-i.y};t._emit("view.rightClick",n,o,e)})}function a(t){this.agGraph=t,this._nodes=[],this._lines=[],this._points=[]}function h(n,i){n=Object.assign({x:0,y:0,size:u,image:"",text:"",badge:"",selected:!1,lines:[],anchorPoints:[]},n);var o=this;o.agGraph=i;var r=["x","y","size","text","image","badge","selected"];o._renderDebounce=t(o._render,f);for(var s in n)r.indexOf(s)<0?o[s]=n[s]:e(o,s,n[s],o._renderDebounce);var a=d3.drag().on("start",function(){o._dragNodeStart()}).on("drag",function(){o._dragNodeMove()}).on("end",function(){o._dragNodeEnd()});a.clickDistance(5),o.$node=i._$nodeGroup.append("g").attr("node-id",o.id).classed("ag-graph-node",!0),o.$node.append("image").classed("ag-graph-node-image",!0),o.$node.call(a).on("click",function(){d3.event.shiftKey?i.selection.toggleNode(o):(i.selection.removeNode(i.selection.nodes()),i.selection.addNode(o)),d3.event.stopPropagation(),i._emit("node.click",o)}).on("contextmenu",function(){d3.event.stopPropagation(),d3.event.preventDefault(),i._emit("node.rightClick",o)})}function d(n,i){n=Object.assign({animate:!1,class:[],selected:!1,text:"",points:[],pointsData:[]},n);var o=this;o.agGraph=i;var r=["class","text","selected"];o._renderDebounce=t(o._render,f);for(var s in n)r.indexOf(s)<0?o[s]=n[s]:e(o,s,n[s],o._renderDebounce);if(o.sourceNode=i.getNode(o.source),o.targetNode=i.getNode(o.target),!o.sourceNode)throw new Error("无效的 source node id: '"+o.source+"'");if(!o.targetNode)throw new Error("无效的 target node id: '"+o.target+"'");o.sourceNode.lines.push(o),o.targetNode.lines.push(o),o.pointsData.length||(o.pointsData=o._getAutoPoints()),o.$line=i._$lineGroup.append("g").attr("line-id",o.id).on("click",function(){d3.event.shiftKey&&o.agGraph.isEditing()?i.selection.toggleLine(o):(i.selection.removeLine(i.selection.lines()),i.selection.addLine(o)),d3.event.stopPropagation(),i._emit("line.click",o)}).on("dblclick",function(){var t=o.agGraph.view._transferToViewPosition(d3.event);o._addPoint(t)}).on("contextmenu",function(){d3.event.stopPropagation(),d3.event.preventDefault(),i._emit("line.rightClick",o)}),o.pointsData.forEach(function(t){o.points.push(new c(t,o))})}function c(n,i){var o=this;o.pointData=n,n=Object.assign({x:0,y:0,selected:!1,anchorNode:null},n),o.line=i;var r=o.line.pointsData.indexOf(o.pointData);0===r&&(o.line.sourceNode.anchorPoints.push(o),n.anchorNode=o.line.sourceNode),r===o.line.pointsData.length-1&&(o.line.targetNode.anchorPoints.push(o),n.anchorNode=o.line.targetNode);var s=["x","y","selected"];o._renderDebounce=t(o._render,f);for(var a in n)s.indexOf(a)<0?o[a]=n[a]:e(o,a,n[a],o._renderDebounce);o.$point=i.agGraph._$pointGroup.append("circle").classed("ag-graph-point",!0).attr("cx",o.x).attr("cy",o.y).attr("r",g);var h=d3.drag().on("start",function(){o._dragPointStart()}).on("drag",function(){o._dragPointMove()});h.clickDistance(5),o.$point.call(h).on("click",function(){d3.event.shiftKey?o.line.agGraph.selection.togglePoint(o):(o.line.agGraph.selection.removePoint(o.line.agGraph.selection.points()),o.line.agGraph.selection.addPoint(o)),d3.event.stopPropagation(),o.line.agGraph._emit("point.click",o)}).on("contextmenu",function(){d3.event.stopPropagation(),d3.event.preventDefault(),o.line.agGraph._emit("point.rightClick",o)})}function p(n,i){n=Object.assign({class:[],repeat:!1},n),this.agGraph=i;var o=["class","selected"];this._renderDebounce=t(this._render,f);for(var r in n)o.indexOf(r)<0?this[r]=n[r]:e(this,r,n[r],this._renderDebounce);this.$path=i._$pathGroup.append("g"),this.$path.append("path").classed("ag-graph-path-line",!0),this.$path.append("g").classed("ag-graph-path-mark",!0).append("use").classed("ag-graph-path-arrow",!0).attr("xlink:href","#path-mark-arrow"),this._render()}function l(t){if(this._config=t,container=document.querySelector(t.container),!container)throw new Error("没有正确的graph容器!");this._container=container,container.innerHTML=x.join("\n"),this.$svg=d3.select(container).select("svg"),this._$nodeGroup=this.$svg.select("#ag-node-group"),this._$lineGroup=this.$svg.select("#ag-line-group"),this._$pointGroup=this.$svg.select("#ag-point-group"),this._$pathGroup=this.$svg.select("#ag-path-group"),this._isEditing=!1,this.view=new s(this),this.view.scale=1,this.selection=new a(this),this.nodes=[],this.lines=[],this.paths=[]}var g=4,u=30,f=10,v="__",y={},_={on:function(t,e){this._events||(this._events=[]);for(var n=t.split(/[\,\s\;]/),i=n.length;i;){var o=n[--i];this._events[o]||(this._events[o]=[]),this._events[o].push(e)}},off:function(t,e){if(this._events||(this._events=[]),t){var n=this._events[t];if(n)if(e)for(var i=n.length;i>0;)n[--i]===e&&n.splice(i,1);else delete this._events[t]}else this._events={}},_emit:function(t){this._events||(this._events=[]);for(var e=[],n=t.split(".");n.length;){var i=n.join("."),o=this._events[i];o&&o.length&&(e=e.concat(o)),n.pop()}var r=Array.prototype.slice.call(arguments,1);if(e.length)for(var s=e.length,a=0;a<s;)e[a].apply(this,r),a++}};s.prototype._setViewBox=function(){this.agGraph.$svg.attr("viewBox",this.viewBox.join(" "))},s.prototype._setScale=function(){var t=this.scale,e=void 0===this.lastScale?1:this.lastScale,n=this.viewBox,i=n[0],o=n[1],r=n[2],s=n[3],a=r*e/t,h=s*e/t,d=(i- -r/2)*t/e+-a/2,c=(o- -s/2)*t/e+-h/2;this.viewBox=[d,c,a,h],this.lastScale=this.scale},s.prototype._transferToViewPosition=function(t){var e=this.agGraph._container.getBoundingClientRect(),n=t.x-e.left,i=t.y-e.top;return{x:this.viewBox[0]+n/this.scale,y:this.viewBox[1]+i/this.scale}},s.prototype.zoomIn=function(){this.scale*=1.3,this.agGraph._emit("view.zoom",this)},s.prototype.zoomOut=function(){this.scale/=1.3,this.agGraph._emit("view.zoom",this)},s.prototype.move=function(t,e){t|=0,e|=0,this.viewBox=[this.viewBox[0]+t,this.viewBox[1]+e,this.viewBox[2],this.viewBox[3]]},a.prototype.nodes=function(){return Array.from(this._nodes)},a.prototype.lines=function(){return Array.from(this._lines)},a.prototype.points=function(){return Array.from(this._points)},a.prototype.toggleNode=function(t){t.selected?this.removeNode(t):this.addNode(t)},a.prototype.addNode=function(t){var e=this;(Array.isArray(t)?t:[t]).forEach(function(t){e._nodes.indexOf(t)<0&&(e._nodes.push(t),t.selected=!0)}),e.agGraph._emit("selection.node.add")},a.prototype.removeNode=function(t){var e=this;(Array.isArray(t)?t:[t]).forEach(function(t){n(e._nodes,t),t.selected=!1}),e.agGraph._emit("selection.node.remove")},a.prototype.clearNodes=function(t){var e=this._nodes.length;this._nodes.forEach(function(t){t.selected=!1}),this._nodes=[],e&&this.agGraph._emit("selection.node.clear")},a.prototype.toggleLine=function(t){t.selected?this.removeLine(t):this.addLine(t)},a.prototype.addLine=function(t){this._lines.indexOf(t)<0&&(this._lines.push(t),t.selected=!0,this.agGraph._emit("selection.line.add",t))},a.prototype.removeLine=function(t){var e=this;(Array.isArray(t)?t:[t]).forEach(function(t){n(e._lines,t),t.selected=!1}),e.agGraph._emit("selection.line.remove")},a.prototype.clearLines=function(t){this._lines.length;this._lines.forEach(function(t){t.selected=!1}),this._lines=[],this.selectedLinesCount&&this.agGraph._emit("selection.line.clear")},a.prototype.togglePoint=function(t){t.selected?this.removePoint(t):this.addPoint(t)},a.prototype.addPoint=function(t){this._points.indexOf(t)<0&&(this._points.push(t),t.selected=!0,this.agGraph._emit("selection.point.add",t))},a.prototype.removePoint=function(t){var e=this;(Array.isArray(t)?t:[t]).forEach(function(t){n(e._points,t),t.selected=!1}),e.agGraph._emit("selection.point.remove")},a.prototype.clearPoints=function(t){this._points.length;this._points.forEach(function(t){t.selected=!1}),this._points=[],this.selectedPointsCount&&this.agGraph._emit("selection.point.clear")},h.prototype._dragNodeStart=function(){if(this.agGraph.isEditing()){d3.event.x,d3.event.y;y.lastPostin={x:d3.event.x,y:d3.event.y}}},h.prototype._dragNodeMove=function(){if(this.agGraph.isEditing()){var t=d3.event.x,e=d3.event.y;this.x+=t-y.lastPostin.x,this.y+=e-y.lastPostin.y,this.anchorPoints.forEach(function(n,i){if(n.line.points.length<=2){var o=n.line._getAutoPoints();n.line.points.forEach(function(t,e){t.x=o[e].x,t.y=o[e].y})}else n.x+=t-y.lastPostin.x,n.y+=e-y.lastPostin.y}),y.lastPostin={x:d3.event.x,y:d3.event.y}}},h.prototype._dragNodeEnd=function(){this.agGraph.isEditing()&&agGraph._emit("node.move",this)},h.prototype._render=function(){var t=this.$node;t.attr("transform","translate("+(this.x-this.size/2)+","+(this.y-this.size/2)+")");if(t.select("image").attr("xlink:href",this.image).attr("width",this.size).attr("height",this.size),t.classed("selected",this.selected),t.selectAll("g").remove(),this.text&&t.append("g").classed("ag-graph-node-text",!0).attr("transform","translate("+this.size/2+","+this.size+")").append("text").text(this.text),this.badge){var e=t.append("g").classed("ag-graph-node-badge",!0).attr("transform","translate("+this.size+","+this.size+")");e.append("circle").attr("r",10),e.append("text").text(this.badge).attr("y",1)}},h.prototype.delete=function(){for(var t=this.lines.length-1;t>=0;)this.lines[t].delete(),t--;this.$node.remove(),this.agGraph.selection.removeNode(this),n(this.agGraph.nodes,this),this.agGraph._emit("node.delete",this)},h.prototype.offset=function(){var t=this.$node.select("image").node().getBoundingClientRect();return{x:t.x,y:t.y}},h.prototype.position=function(){var t=this.$node.select("image").node().getBoundingClientRect(),e=this.agGraph._container.offsetParent.getBoundingClientRect();return{x:t.x-e.x,y:t.y-e.y}},d.prototype._getAutoPoints=function(){var t=Math.PI*o({x:this.sourceNode.x,y:this.sourceNode.y},{x:this.targetNode.x,y:this.targetNode.y})/180,e={x:(this.sourceNode.size/2+4)*Math.cos(t),y:(this.sourceNode.size/2+4)*Math.sin(t)},n={x:-(this.targetNode.size/2+4)*Math.cos(t),y:-(this.targetNode.size/2+4)*Math.sin(t)};return[{x:this.sourceNode.x+e.x,y:this.sourceNode.y+e.y},{x:this.targetNode.x+n.x,y:this.targetNode.y+n.y}]},d.prototype._addPoint=function(t){var e=0,n=0;this.pointsData.reduce(function(i,r,s){var a=function(t,e){var n=e[0],i=e[1],r=Math.abs(o(t,i)-o(t,n));return r>180&&(r=360-r),r}(t,[i,r]);return a>e&&(e=a,n=s),r}),this.pointsData.splice(n,0,t);var i=new c(t,this);this.points.splice(n,0,i),this._renderDebounce(),this.agGraph._emit("point.add",i)},d.prototype._render=function(t){this.$line.selectAll("*").remove();var e=this.$line.append("polyline").attr("points",this.pointsData.map(function(t){return t.x+","+t.y}).join(" "));if(this.animate&&t&&e.transition().duration(500).attrTween("stroke-dasharray",function(){var t=this.getTotalLength();return function(e){return d3.interpolateString("0,"+t,t+",0")(e)}}).on("end",function(){e.attr("stroke-dasharray",null)}),this.text){var n=function(t){var e=0;return t.forEach(function(n,o){o&&(e+=i(n,t[o-1]))}),e}(this.pointsData),o=r(this.pointsData,n/2);o.angel>90&&o.angel<270&&(o.angel+=180),this.$line.append("g").attr("transform","translate("+o.x+","+o.y+")").append("text").attr("transform","rotate("+o.angel+")").text(this.text)}var s=["ag-graph-line"];Array.isArray(this.class)?s=s.concat(this.class):s.push(this.class),this.selected&&s.push("selected"),this.$line.attr("class",s.join(" "))},d.prototype.delete=function(){var t=this;t.points.length;t.points.forEach(function(e){e.anchorNode&&n(e.anchorNode.anchorPoints,e),e.$point.remove(),t.agGraph.selection.removePoint(e)}),t.$line.remove(),t.agGraph.selection.removeLine(t),n(t.sourceNode.lines,t),n(t.targetNode.lines,t),n(t.agGraph.lines,t),t.agGraph._emit("line.delete",t)},c.prototype._dragPointStart=function(){var t=d3.event.x,e=d3.event.y;y.offset={x:t-this.x,y:e-this.y}},c.prototype._dragPointMove=function(){var t=d3.event.x,e=d3.event.y;this.x=t-y.offset.x,this.y=e-y.offset.y},c.prototype._dragPointEnd=function(){_this.line.agGraph._emit("point.move",this)},c.prototype._render=function(){this.$point.attr("cx",this.x).attr("cy",this.y).classed("selected",this.selected),this.pointData.x=this.x,this.pointData.y=this.y,this.line._renderDebounce()},c.prototype.delete=function(){if(this.anchorNode)throw new Error("不能删除连线两端的点");var t=this.line.points.indexOf(this);this.line.agGraph.selection.removePoint(this),this.line.points.splice(t,1),this.line.pointsData.splice(t,1),this.$point.remove(),this.line._renderDebounce(),this.line.agGraph._emit("point.delete",this)},p.prototype._getConnectedNodePoint=function(t,e){var n=[],i=t.lines.find(function(t){return t.source===e.id||t.target===e.id});return i&&(n=Array.from(i.pointsData),i.target===t.id&&n.reverse()),n},p.prototype._getPathNode=function(){var t=this,e=t.source,n=t.target,i=t.agGraph.getNode(e),o=t.agGraph.getNode(n),r=[];if(i&&o){for(var s={},a=[{id:e,preNode:null,node:i}];!s[n]&&a.length;){var h=[];a.forEach(function(e){h=h.concat(t.agGraph.getNeighborNodes(e.node).filter(function(t){return!s[t.id]}).map(function(t){return{id:t.id,preNode:e,node:t}}))}),h.forEach(function(t){s[t.id]=t}),a=h}if(s[n]){for(var d=s[n];d;)r.push(d.node),d=d.preNode;return r.reverse()}}return r},p.prototype._getPathPoints=function(){var t=this,e=(t.source,t.target,this._getPathNode()),n=[];return e&&e.length&&e.reduce(function(e,i){return n.push(t._getConnectedNodePoint(e,i)),i}),n},p.prototype._renderLine=function(t){var e=this;if(!e._deleted){var n=e.$path.select(".ag-graph-path-mark"),i=n.select(".ag-graph-path-arrow");if(t.length){var o=e.$path.append("polyline").attr("points",function(){return t[0].map(function(t){return t.x+","+t.y}).join(" ")});o.transition().duration(5*o.node().getTotalLength()).ease(function(t){return t}).attrTween("stroke-dasharray",function(){var e=this.getTotalLength();return function(o){var s=d3.interpolateString("0,"+e,e+",0")(o),a=+s.split(",")[0],h=r(t[0],a);return h&&(n.attr("transform","translate("+h.x+","+h.y+")"),i.attr("transform","rotate("+h.angel+")")),s}}).on("end",function(){o.attr("stroke-dasharray",null),t.shift(),e._renderLine(t)})}else e.repeat&&setTimeout(function(){e.$path.selectAll("polyline").remove(),e._renderLine(e._getPathPoints())},500)}},p.prototype._render=function(){var t=["ag-graph-path"];Array.isArray(this.class)?t=t.concat(this.class):t.push(this.class),this.$path.attr("class",t.join(" "));var e=this._getPathPoints();e.length?(this.$path.style("display",""),this.$path.selectAll("polyline").remove(),this._renderLine(e)):this.$path.style("display","none")},p.prototype.delete=function(){this._deleted=!0,this.$path.remove(),n(this.agGraph.paths,this)};var x=['<svg style="width:100%;height:100%;" class="ag-graph">',"   <defs>",'       <filter id="node-selected" height="200%" width="200%">','           <feGaussianBlur stdDeviation="2"/>','           <feOffset dx="-6" dy="-6" />',"           <feMerge>","               <feMergeNode/>",'               <feMergeNode in="SourceGraphic"/>',"           </feMerge>","       </filter>",'       <path id="path-mark-arrow" d="M-4,-6 L4,0 L-4,6 L-4,-6"> fill="red"',"       </defs>",'   <g id="ag-line-group"></g>','   <g id="ag-node-group"></g>','   <g id="ag-point-group"></g>','   <g id="ag-path-group"></g>',"</svg>"];return l.prototype=Object.assign(_,l.prototype),l.prototype.addNode=function(t){var e=new h(t,this);return e._render(),this.nodes.push(e),this._emit("node.add",e),e},l.prototype.getNeighborNodes=function(t){var e=this,n=[];return t.lines.forEach(function(i){var o=e.getNode(i.target),r=e.getNode(i.source);r!==t&&n.push(r),o!==t&&n.push(o)}),n},l.prototype.getNode=function(t){return this.nodes.find(function(e){return e.id===t})},l.prototype.addLine=function(t){var e=new d(t,this);return e._render(!0),this.lines.push(e),this._emit("line.add",e),e},l.prototype.getLinesInNodes=function(t){var e={};t.forEach(function(t){e[t.id]=t});var n=[];agGraph.lines.forEach(function(t){e[t.source]&&e[t.target]&&n.push(t)})},l.prototype.getLine=function(t){return this.lines.find(function(e){return e.id===t})},l.prototype.isEditing=function(){return this._isEditing},l.prototype.startEdit=function(){this._isEditing=!0,this.$svg.classed("editing",!0);for(var t=this.paths.length;t;)this.paths[t-1].delete(),t--},l.prototype.endEdit=function(){this._isEditing=!1,this.$svg.classed("editing",!1)},l.prototype.addPath=function(t){if(this.isEditing())throw new Error("编辑模式无法添加路径");t=new p(t,this);return this.paths.push(t),t},l.prototype.getPath=function(t){return this.paths.find(function(e){return e.id===t})},l.prototype.getNodesData=function(t){return this.nodes.map(function(e){return t(e)})},l.prototype.getLinesData=function(t){return this.lines.map(function(e){return t(e)})},l._version="1.0.2",l},window);
